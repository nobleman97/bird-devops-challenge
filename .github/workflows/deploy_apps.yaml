name: 'Apps Pipeline'

env:
 TF_LOG: INFO
 AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
 AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

on:
  workflow_dispatch:

jobs:
  configure-jumpbox:
    name: 'Deploy Apps'
    runs-on: 'ubuntu-latest'
    environment: 'demo'
    
    defaults:
      run:
        shell: bash
        working-directory: "infrastructure/terraform/infra"
    
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2

      - name: 'Install Terraform'
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Create Tfvars file with sensitive data
        run: |
          cat <<EOF > extra.auto.tfvars
          cloudflare_api_token = "${{ secrets.CF_API_TOKEN }}"
          cloudflare_api_key   = "${{ secrets.CF_API_KEY }}"
          cloudflare_email     = "${{ secrets.CF_EMAIL }}"
          cloudflare_zone_id   = "${{ secrets.CF_ZONE_ID }}"
          instance_key = {
            name   = "lifi"
            public_key = "${{ secrets.PUBLIC_KEY }}"
          }
          smtp_password = "${{ secrets.SMTP_PWD }}"
          EOF

      - name: 'Grab KubeConfig'
        run: |
          sudo apt update -y
          sudo snap install aws-cli --classic || echo "already installed"

          export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
          export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

          aws s3 ls  s3://infra-shakazu-bucket/lifi/

          # aws s3 cp  s3://infra-shakazu-bucket/lifi/config.yaml config.yaml

          # master_ip=$(terraform output | grep master | grep -v kubectl | awk '{print $3}' | sed 's/\"//g')
         
          # sed -i "s|https://127.0.0.1|http://$master_ip|g" config.yaml || echo "all good"

          # aws s3 cp config.yaml s3://infra-shakazu-bucket/lifi/config.yaml 

      - name: Set up SSH
        run: |
          jumpbox_ip=$(terraform output | grep jumpbox | grep -v kubectl | awk '{print $3}' | sed 's/\"//g')
          echo "bastion is $jumpbox_ip"
          sudo apt update
          sudo apt install -y openssh-client
          eval $(ssh-agent -s)
          echo "$jumpbox_ip" | tr -d '\r' | ssh-add -
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan "$jumpbox_ip" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

      - name: Clone repo
        run: |
          jumpbox_ip=$(terraform output | grep jumpbox | grep -v kubectl | awk '{print $3}' | sed 's/\"//g')
          ssh -o StrictHostKeyChecking=no "ubuntu@$jumpbox_ip" -p 22 "sudo apt install git -y && git clone https://github.com/nobleman97/bird-devops-challenge.git"
        
      - name: Add sensitive values
        run: |
          jumpbox_ip=$(terraform output | grep jumpbox | grep -v kubectl | awk '{print $3}' | sed 's/\"//g')
          scp -o StrictHostKeyChecking=no -P 22 extra.auto.tfvars "ubuntu@$jumpbox_ip:~/bird*/infrastructure/terraform/apps"
          

    